<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="Andreas Nicolai">
<title>SIM-VICUS Plugin Entwicklung</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url(../css/asciidoctor.css); /* Default asciidoc style framework - important */

/* roboto-condensed-regular - latin */
@font-face {
  font-family: 'Roboto Condensed';
  font-style: normal;
  font-weight: 400;
  src: url('../fonts/roboto-condensed-v25-latin-regular.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('../fonts/roboto-condensed-v25-latin-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('../fonts/roboto-condensed-v25-latin-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-regular.woff') format('woff'), /* Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('../fonts/roboto-condensed-v25-latin-regular.svg#RobotoCondensed') format('svg'); /* Legacy iOS */
}
/* roboto-condensed-italic - latin */
@font-face {
  font-family: 'Roboto Condensed';
  font-style: italic;
  font-weight: 400;
  src: url('../fonts/roboto-condensed-v25-latin-italic.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('../fonts/roboto-condensed-v25-latin-italic.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('../fonts/roboto-condensed-v25-latin-italic.woff2') format('woff2'), /* Super Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-italic.woff') format('woff'), /* Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-italic.ttf') format('truetype'), /* Safari, Android, iOS */
       url('../fonts/roboto-condensed-v25-latin-italic.svg#RobotoCondensed') format('svg'); /* Legacy iOS */
}
/* roboto-condensed-700 - latin */
@font-face {
  font-family: 'Roboto Condensed';
  font-style: normal;
  font-weight: 700;
  src: url('../fonts/roboto-condensed-v25-latin-700.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('../fonts/roboto-condensed-v25-latin-700.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('../fonts/roboto-condensed-v25-latin-700.woff2') format('woff2'), /* Super Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-700.woff') format('woff'), /* Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-700.ttf') format('truetype'), /* Safari, Android, iOS */
       url('../fonts/roboto-condensed-v25-latin-700.svg#RobotoCondensed') format('svg'); /* Legacy iOS */
}
/* roboto-condensed-700italic - latin */
@font-face {
  font-family: 'Roboto Condensed';
  font-style: italic;
  font-weight: 700;
  src: url('../fonts/roboto-condensed-v25-latin-700italic.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('../fonts/roboto-condensed-v25-latin-700italic.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('../fonts/roboto-condensed-v25-latin-700italic.woff2') format('woff2'), /* Super Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-700italic.woff') format('woff'), /* Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-700italic.ttf') format('truetype'), /* Safari, Android, iOS */
       url('../fonts/roboto-condensed-v25-latin-700italic.svg#RobotoCondensed') format('svg'); /* Legacy iOS */
}

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */

:root{
--maincolor:#FFFFFF;
--primarycolor:#a90e22;
--secondarycolor:#9f1d0b;
--tertiarycolor: #ededed;
--sidebarbackground:#CCC;
--linkcolor:#b71c1c;
--linkcoloralternate:#f44336;
--white:#FFFFFF;
--black:#000000;
}

/* Text styles */
body{font-family: "Roboto Condensed",sans-serif;}

h1,h2{color:var(--primarycolor) !important;font-family:"Roboto Condensed",sans-serif;}
h3,h4,h5,h6{color:var(--secondarycolor);font-family: "Roboto Condensed",sans-serif; }
.title{color:(--primarycolor) !important;font-family:"Roboto Condensed",sans-serif;font-style: normal; font-weight: normal;}
p{font-family: "Roboto Condensed",sans-serif ! important}
#toc.toc2 a{font-family:"Roboto Condensed",sans-serif;}
/*#toc.toc2 a:link{color:(--linkcolor) !important}
a:visited {color: #ffdbad;}
a.bare:visited {color: #204f83;}
a:hover {color: #317ed4;}
#toc.toc2 a:hover {color: #f1b464;}*/
/* code{background-color: var(--secondarycolor) !important;color:var(--white)} */
code,kbd,pre,samp{font-family:"Consolas","Droid Sans Mono","DejaVu Sans Mono",monospace;monospace;font-size:1em}

/* Table styles */
th{background-color: var(--tertiarycolor);color:var(--black) !important;}

#toctitle{color:var(--primarycolor);font-family: "Roboto Condensed",sans-serif;font-size: 1.6875em;}
#toc.toc2{background-color:#f4f8fd;}
/*#toc.toc2{background-color:#2C001E;color:white;}
#toc.toc2.a{color:white;}
*/

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}

</style>
<link rel="stylesheet" href="../css/font-awesome.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SIM-VICUS Plugin Entwicklung</h1>
<div class="details">
<span id="author" class="author">Andreas Nicolai</span><br>
<span id="email" class="email"><a href="https://github.com/ghorwin" class="bare">https://github.com/ghorwin</a></span><br>
<span id="revnumber">version 1.0 (01.01.2023)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Inhaltsverzeichnis</div>
<ul class="sectlevel1">
<li><a href="#_hintergrund_informationen">1. Hintergrund-Informationen</a>
<ul class="sectlevel2">
<li><a href="#_dynamische_bibliotheken_und_binärkompatibilität">1.1. Dynamische Bibliotheken und Binärkompatibilität</a></li>
<li><a href="#_quelltextunterschiede_und_versionierung">1.2. Quelltextunterschiede und Versionierung</a>
<ul class="sectlevel3">
<li><a href="#_fall_1_gemeinsam_genutzte_datenstruktur_im_hauptprogramm_ändert_sich">1.2.1. Fall 1: Gemeinsam genutzte Datenstruktur im Hauptprogramm ändert sich</a></li>
<li><a href="#_fall_2_plugin_schnittstelle_ändert_sich">1.2.2. Fall 2: Plugin-Schnittstelle ändert sich</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_plugin_entwicklung">2. Plugin-Entwicklung</a>
<ul class="sectlevel2">
<li><a href="#_implementieren_der_schnittstelle">2.1. Implementieren der Schnittstelle</a></li>
<li><a href="#_plugin_meta_daten">2.2. Plugin-Meta-Daten</a></li>
<li><a href="#_plugin_erstellung">2.3. Plugin-Erstellung</a></li>
<li><a href="#_plugin_veröffentlichung">2.4. Plugin-Veröffentlichung</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_hintergrund_informationen">1. Hintergrund-Informationen</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_dynamische_bibliotheken_und_binärkompatibilität">1.1. Dynamische Bibliotheken und Binärkompatibilität</h3>
<div class="paragraph">
<p>Plugins sind letztlich dynamisch geladene Bibliotheken, bzw. <em>shared library</em> oder <em>dynamically linked library (DLL)</em>. Zum Verständnis der Versionierungsanforderungen unten hilft vielleicht ein kurzer Einblick in die interne Funktionsweise von C/C++.</p>
</div>
<div class="paragraph">
<p>In C/C++ werden Variablen über Speicheradressen verwaltet. Über die Adresse im Speicher und den Typ weiß der Compiler, wie der rohe Speicherinhalt zu interpretieren ist.
Bei Objekten (<em>struct</em> oder <em>class</em>) wird die Adresse auf den Beginn des Objekts gespeichert. Bei Membervariablen weiß der Compiler dann durch deren Typen und <em>offset</em> (Abstand von der Startadresse des Objekts), wo im darauffolgenden Speicher deren Daten liegen.</p>
</div>
<div class="paragraph">
<p>Der <em>offset</em> einer Membervariablen ist aber nicht nur von der Größe der jeweiligen Datentypen abhängig. Zusätzlich werden die einzelnen Variablen noch am Speicherraster ausgerichtet, durch ein sogenanntes <em>padding</em> (siehe auch <a href="https://en.wikipedia.org/wiki/Data_structure_alignment" class="bare">https://en.wikipedia.org/wiki/Data_structure_alignment</a> ).</p>
</div>
<div class="paragraph">
<p>Das Padding ist compiler- und plattformabhängig, da das binäre Speicherlayout bei C/C++ nicht standardisiert ist (was auch gut ist, da so hardwarespezifisch optimaler Code generiert werden kann). Man kann das beispielsweise austesten, indem man das Testprogramm <a href="#ex_struct">Beispiel 1</a> mit verschiedenen Compilern und Betriebssystemen ausführt.</p>
</div>
<div id="ex_struct" class="exampleblock">
<div class="title">Beispiel 1. Beispiel für die unterschiedliche Größe von Strukturen durch Padding in Abhängigkeit von Typ und Reihenfolge der Membervariablen. <code>sizeof</code> liefert den Speicherbedarf für eine Variable, <code>offsetof</code> liefert die Anzahl der Bytes zwischen Aresse des Objekts und Adresse der Membervariablen.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">A</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span><span class="p">;</span> <span class="c1">// 1 Byte</span>
    <span class="kt">char</span> <span class="n">d</span><span class="p">;</span> <span class="c1">// 1 Byte</span>
            <span class="c1">// 2 Byte Padding</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>  <span class="c1">// 4 Byte</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">B</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span><span class="p">;</span> <span class="c1">// 1 Byte</span>
            <span class="c1">// 3 Byte Padding</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>  <span class="c1">// 4 Byte</span>
    <span class="kt">char</span> <span class="n">d</span><span class="p">;</span> <span class="c1">// 1 Byte</span>
            <span class="c1">// 3 Byte Padding</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">A</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">B</span> <span class="n">b</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Size of A: "</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"  Offset of A.d: "</span> <span class="o">&lt;&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"  Offset of A.i: "</span> <span class="o">&lt;&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Size of B: "</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"  Offset of B.i: "</span> <span class="o">&lt;&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"  Offset of B.d: "</span> <span class="o">&lt;&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// Ausgabe:</span>
<span class="c1">// Size of A: 8</span>
<span class="c1">//   Offset of A.d: 1</span>
<span class="c1">//   Offset of A.i: 4</span>
<span class="c1">// Size of B: 12</span>
<span class="c1">//   Offset of B.i: 4</span>
<span class="c1">//   Offset of B.d: 8</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Am Beispiel wird deutlich, dass die Reihenfolge der Membervariablen in einem struct oder einer Klasse Auswirkungen auf die Speicheranordnung hat. Bei unterschiedlichen Compilern/Plattformen kann das auch individuell unterschiedlich gemacht werden, sodass aus dem gleichen C/C++-Code von unterschiedlichen Compilern generierter Binärcode eventuell unterschiedlich im Speicher abgelegt wird.  Glücklicherweise machen die meisten Compiler heutzutage auf x86 bzw. x64-Systemen das Gleiche, man kann sich jedoch leider <em>nicht darauf verlassen</em>.</p>
</div>
<div class="paragraph">
<p>Das ist wichtig wenn eine dynamisch geladene Bibliothek direkten Speicherzugriff auf Datenstrukturen des ladenden Programmes bekommt, oder letzteres auf Speicherbereiche zugreift, die von der Shared Lib befüllt wurden.</p>
</div>
<div class="paragraph">
<p>Daraus leitet sich die erste Grundregel ab bei der Verwendung von dynamisch geladenen Bibliotheken ab:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Host-Programm und DLLs müssen stets mit binär-compatiblen Compilern compiliert werden. Das muss nicht zwingend die gleiche Compiler-Version sein. Z.B. gilt Binärcompatibilität für eine Reihe von Visual Studio Compilern (ab 2015/VC14), siehe <a href="https://learn.microsoft.com/en-us/cpp/porting/binary-compat-2015-2017?view=msvc-170" class="bare">https://learn.microsoft.com/en-us/cpp/porting/binary-compat-2015-2017?view=msvc-170</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_quelltextunterschiede_und_versionierung">1.2. Quelltextunterschiede und Versionierung</h3>
<div class="paragraph">
<p>Software "lebt" und wird weiterentwickelt. Dies gilt für Plugins und für das eigentliche Hauptprogramm gleichermaßen. Die Trennung von Plugin und Hauptsoftware hat ja auch den Grund, dass ein (externer) Pluginentwickler eigene, vom Hauptprogramm unabhängige Release-Zyklen haben kann und z.B. ein Plugin auch für mehrere Hauptprogrammversionen gültig sein kann. Allerdings sind Hauptprogramm und Plugin nicht komplett unabhängig, wenn Sie gemeinschaftlich auf Daten im Speicher zugreifen bzw. komplexe Objekte austauschen.</p>
</div>
<div class="paragraph">
<p>Die größte Unabhängigkeit zwischen Plugin und Hauptprogramm erreicht man, wenn man:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>keine komplexen Datentypen zum Datenaustausch nutzt, sondern ausschließlich einfache Datentypen (<em>PODs - plain old data types</em>) wie int, bool, double, char austauschen. Ein <code>std::string</code> ist bereits ein komplexer Datentyp, sodass zum Austausch von Zeichenketten meist nur ein <code>const char *</code> verwendet wird.</p>
</li>
<li>
<p>keinen gegenseitigen Speicherzugriff auf den jeweiligen Datenbereich des Plugins oder Hauptprogramms erlaubt</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Allerdings ist das für umfangreichere (also quasi alle sinnvollen) Plugins <strong><em>nicht praktikabel</em></strong>. Es müssen also zwischen Veränderungen des Quelltextes gegenüber einer einheitlichen Ausgangsvariante, mit der sowohl Hauptprogramm als auch Plugin compiliert wurden, erkannt und behandelt werden.</p>
</div>
<div class="sect3">
<h4 id="_fall_1_gemeinsam_genutzte_datenstruktur_im_hauptprogramm_ändert_sich">1.2.1. Fall 1: Gemeinsam genutzte Datenstruktur im Hauptprogramm ändert sich</h4>
<div class="paragraph">
<p>Dies ist einer der häufigten Fälle und betrifft im Fall von SIM-VICUS zumeist das Datenmodell in der <em>VICUS</em> Bibliothek und dadurch auch <em>NANDRAD</em> und die <em>IBK</em> Libs (und alle anderen Bibliotheken, die Datenstrukturen von Membervariablen innerhalb von <code>VICUS::Project</code> deklarieren).</p>
</div>
<div class="paragraph">
<p>Nehmen wir an, es gibt eine Veränderung in einer Klasse <code>PlainGeometry</code> wie im <a href="#ex_plainGeometry">Beispiel 2</a> gezeigt.</p>
</div>
<div id="ex_plainGeometry" class="exampleblock">
<div class="title">Beispiel 2. Typische Erweiterung einer Datenstruktur während des Entwicklungsprozesses; hierbei wird eine neue Membervariable <code>m_displayName</code> hinzugefügt, welche die bisherigen Membervariablen innerhalb des Objekts im Speicher nach hinten verschiebt.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="c1">// Ursprungsversion</span>
<span class="k">class</span> <span class="nc">PlainGeometry</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="c1">// ...</span>

    <span class="cm">/*! Polygons with holes/subsurfaces inside the polygon. */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Surface</span><span class="o">&gt;</span>                        <span class="n">m_surfaces</span><span class="p">;</span>             <span class="c1">// XML:E</span>
    <span class="cm">/*! Indicates whether all children elements are visible. */</span>
    <span class="kt">bool</span>                                        <span class="n">m_visible</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>       <span class="c1">// XML:A</span>
    <span class="cm">/*! Indicates whether all children elements are selected. */</span>
    <span class="kt">bool</span>                                        <span class="n">m_selected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">};</span>



<span class="c1">// Neue Version</span>
<span class="k">class</span> <span class="nc">PlainGeometry</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="c1">// ...</span>

    <span class="cm">/*! Descriptive name. */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span>                                 <span class="n">m_displayName</span><span class="p">;</span>          <span class="c1">// XML:A</span>
    <span class="cm">/*! Polygons with holes/subsurfaces inside the polygon. */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Surface</span><span class="o">&gt;</span>                        <span class="n">m_surfaces</span><span class="p">;</span>             <span class="c1">// XML:E</span>
    <span class="cm">/*! Indicates whether all children elements are visible. */</span>
    <span class="kt">bool</span>                                        <span class="n">m_visible</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>       <span class="c1">// XML:A</span>
    <span class="cm">/*! Indicates whether all children elements are selected. */</span>
    <span class="kt">bool</span>                                        <span class="n">m_selected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Nehmen wir mal an, das Plugin wurde mit der Ursprungsversion kompiliert und das Hauptprogramm bereits mit der neuen Version. Nun wird das Plugin geladen, erhält vom Hauptprogramm die Adresse eines <code>PlainGeometry</code> Objekts und greift auf die Membervariable <code>m_surfaces</code> zu. Im Quelltext des Plugins stand diese Variable an erster Stelle (offset 0), allerdings steht im Speicher des vom Hauptprogramm übergebenen Objekts nun ein String (beim offset 0). Beim Zugriff und Auswertung des Speicherbereichs wird das Plugin nun string-Daten als vector interpretieren und mit hoher Wahrscheinlichkeit mit einer Access Violoation/SEGFAULT crashen.</p>
</div>
<div class="paragraph">
<p><strong>Das Problem:</strong> sowohl das Hauptprogramm als auch das Plugin können derartige Unterschiede nicht einfach erkennen (die Prüfung der binäre Struktur aller beteiligter Klassen ist quasi unmöglich).</p>
</div>
<div class="paragraph">
<p><strong>Lösung:</strong> Das Hauptprogramm muss anhand von <em>Plugin-Metadaten</em> feststellen, ob das Plugin mit der gleichen Datenstruktur-Version kompiliert wurde.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Plugins müssen Metadaten mitliefern, die Auskunft über die verwendeten Datenstrukturversionen bzw. Bibliotheksversionen geben.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ein Beispiel für solche Metadaten wäre, wenn das Plugin mitteilt, für welche Hauptprogrammversionen (=Datenstrukturversion) ein Plugin anzuwenden ist, also beispielsweise <code>vicus-version : 0.9.4</code>. In der Regel ist dies immer exakt eine SIM-VICUS Release-Version. Bei der Veröffentlichung der nächsten Version würden daher alle alten Plugins automatisch deaktiviert, d.h. nicht geladen werden.</p>
</div>
<div class="paragraph">
<p>Da ein Plugin jedoch meist nur Teile einer Datenstruktur verwendet, kann es bei bestimmten Datenstrukturänderungen durchaus möglich sein, ein älteres Plugin weiter zu verwenden. Ein Beispiel dafür wäre ein Plugin, welches mit Materialdaten arbeitet. Wenn in der Datenstruktur lediglich Änderungen an Netzwerkklassen vorgenommen werden, dann sind derartige Versionsänderungen für das Plugin unwichtig. Das kompilierte Plugin kann auch bei neueren Versionen des Hauptprogramms weiter verwendet werden - man muss nur die Metadaten anpassen. In diesem Fall würde man den Zulässigkeitsbereich des Plugins auf die nächste Hauptprogrammversion erweitern, z.B. <code>vicus-version : 0.9.4..0.9.5</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Achtung"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Die Pflege der Metadaten und Kompatibilitätsversionen ist für korrekt funktionierende Plugins kritisch!</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_fall_2_plugin_schnittstelle_ändert_sich">1.2.2. Fall 2: Plugin-Schnittstelle ändert sich</h4>
<div class="paragraph">
<p>Unter <em>Plugin-Schnittstelle</em> versteht man die Deklaration der Funktionen, die im Plugin seitens des Hauptprogramms aufgerufen werden. <a href="#ex_PluginInterface">Beispiel 3</a> zeigt eine solche Schnittstelle für ein Datenbank-Plugin.</p>
</div>
<div id="ex_PluginInterface" class="exampleblock">
<div class="title">Beispiel 3. Plugin-Schnittstellen-Deklaration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="cm">/*! Interface for a plugin that provides VICUS database elements. */</span>
<span class="k">class</span> <span class="nc">SVDatabasePluginInterface</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="cm">/*! Virtual D'tor. */</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">SVDatabasePluginInterface</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

    <span class="cm">/*! Returns a title text for the plugin, used in the main menu for settings and
        for info/error messages. Used like "Configure xxxx..." and "About xxxx...".
    */</span>
    <span class="k">virtual</span> <span class="n">QString</span> <span class="n">title</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/*! This function needs to be implemented by the database plugin to populate the database with its own data.
    */</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">retrieve</span><span class="p">(</span><span class="k">const</span> <span class="n">SVDatabase</span> <span class="o">&amp;</span> <span class="n">currentDB</span><span class="p">,</span> <span class="n">SVDatabase</span> <span class="o">&amp;</span> <span class="n">augmentedDB</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define SVDatabasePluginInterface_iid "ibk.sim-vicus.Plugin.DatabaseInterface/1.0"
</span>
<span class="n">Q_DECLARE_INTERFACE</span><span class="p">(</span><span class="n">SVDatabasePluginInterface</span><span class="p">,</span> <span class="n">SVDatabasePluginInterface_iid</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Bei einer solchen Schnittstellendeklaration handelt es sich einfach um eine Klasse mit virtuellen Memberfunktionen. Diese Schnittstelle wird vom konkreten Plugin geerbt und implementiert (im Plugin-Quelltext). Die Schnittstellendeklaration teilt dem Hauptprogramm lediglich mit, welche Funktionen mit welchen Argumenten vom Plugin zur Verfügung gestellt werden.</p>
</div>
<div class="paragraph">
<p>Wenn das Hauptprogramm nun eine dynamische Bibliothek lädt, dann wird zunächst nur ein Zeiger auf die Klassenschnittstelle (das Objekt des Plugins) geladen. Das Hauptprogramm könnte nun mittels <code>dynamic_cast</code> prüfen, ob es sich um ein Plugin einer bestimmten Schnittstellendeklaration handelt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="kt">void</span> <span class="o">*</span> <span class="n">ptrToPlugin</span> <span class="o">=</span> <span class="p">...</span> <span class="p">;</span> <span class="c1">// Zeiger hält Plugin-Objekt-Adresse</span>

<span class="n">SVDatabasePluginInterface</span> <span class="o">*</span> <span class="n">dbPlugin</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">SVDatabasePluginInterface</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">ptrToPlugin</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">dbPlugin</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// es ist ein DB-Plugin!</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Eine Schnittstellendeklaration ändert sich z.B. dann, wenn das Hauptprogramm eine neue Funktion für das Plugin oder ein verändertes Verhalten unterstützt. Im Gegensatz zur Fall 1 oben muss das nicht zwingend eine Datenstrukturänderung bedingen, es kann z.B. einfach ein neues Argument sein, was zu einer deklarierten Funktion hinzugefügt wird.</p>
</div>
<div class="paragraph">
<p><strong>Das Problem:</strong> Wenn sich innerhalb der Deklaration von <code>SVDatabasePluginInterface</code> eine Memberfunktion ändert, z.B. die Argumente geändert werden oder neue Funktionen hinzugefügt werden, dann ändert sich dadurch nicht der Typ des Objekts. D.h. der <code>dynamic_cast</code> liefert weiterhin eine gültige Adresse.  Wenn nun das Hauptprogramm mittels dieser Adresse eine neue Memberfunktion (deklariert in einer neuen Version der Pluginschnittstelle im Hauptprogramm) im Plugin (kompiliert mit alter Schnittstelle) aufruft, führt dies zu einer Access Violation/SEGFAULT.</p>
</div>
<div class="paragraph">
<p><strong>Die Lösung:</strong> Die Schnittstelle, d.h. die gesamte Deklaration der Schnittstelle muss seitens des Hauptprogramms bei der Zeigerkonvertierung auf Passgenauigkeit geprüft werden. Dies gelingt <em>nicht</em> mit <code>dynamic_cast</code>, jedoch bietet Qt die Möglichkeit, mittels <code>qobject_cast</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="n">SVDatabasePluginInterface</span> <span class="o">*</span> <span class="n">dbPlugin</span> <span class="o">=</span> <span class="n">qobject_cast</span><span class="o">&lt;</span><span class="n">SVDatabasePluginInterface</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ptrToPlugin</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die <code>qobject_cast</code>-Funktion prüft dabei zusätzlich noch die Interface-ID, welche mit</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="cp">#define SVDatabasePluginInterface_iid "ibk.sim-vicus.Plugin.DatabaseInterface/1.0"
</span>
<span class="n">Q_DECLARE_INTERFACE</span><span class="p">(</span><span class="n">SVDatabasePluginInterface</span><span class="p">,</span> <span class="n">SVDatabasePluginInterface_iid</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>festgelegt wird. Nehmen wir mal an, dass das Plugin kompiliert wird und dabei die Interface-ID als <code>ibk.sim-vicus.Plugin.DatabaseInterface/1.0</code> festgelegt wird. Nun ändert sich die Schnittstelle im Hauptprogramm und seitens des Hauptprogramms wird die Versionsnummer auf <code>ibk.sim-vicus.Plugin.DatabaseInterface/2.0</code> erhöht. Beim Einladen des Plugins mit der alten Schnittstelle liefert der <code>qobject_cast</code> nun wegen unpassender Interface-IDs einen n ullptr zurück. Dadurch kann man absichern, dass die Schnittstelle zum Zeitpunkt der Plugin- und Hauptprogramm-Kompilierung identisch sind.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Sobald man die Schnittstelle eines Plugins (oder Elternklasse) im Hauptprogramm ändert, muss man die Interface-ID anpassen!</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_plugin_entwicklung">2. Plugin-Entwicklung</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Folgende Schritte sind für die Entwicklung eines Plugins notwendig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Kopieren eines Plugin-Beispiel-Projektverzeichnisses <code>SIM-VICUS/plugins/xxx</code> und Anpassen/Umbenennen der Dateinamen und <code>.pro</code> und <code>CMakeLists.txt</code>-Dateien</p>
</li>
<li>
<p>Aktualisieren der Meta-Daten JSON-Datei (siehe Beispiel unten)</p>
</li>
<li>
<p>Implementieren der Plugin-Schnittstelle (siehe Beispiel unten)</p>
</li>
<li>
<p>Plugin kompilieren</p>
</li>
<li>
<p>Plugin veröffentlichen: Plugin als zip-Datei + Meta-Daten JSON auf Server hochladen in Verzeichnisstruktur (siehe Beispiel unten)</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_implementieren_der_schnittstelle">2.1. Implementieren der Schnittstelle</h3>
<div class="paragraph">
<p>Für alle Plugins müssen die allgemeinen Schnittstellenfunktionen implementiert werden:</p>
</div>
<div class="listingblock">
<div class="title">Schnittstellenfunktionen für alle Plugins (<code>SVCommonPluginInterface</code>)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="cpp"><span class="cm">/*! Returns a title text for the plugin, used in the main menu for settings and
    for info/error messages. Used like "Configure xxxx..." and "About xxxx...".
*/</span>
<span class="k">virtual</span> <span class="n">QString</span> <span class="n">title</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

<span class="cm">/*! Optionally return a pixmap to show in the plugin manager.
    nullptr means "use default plugin icon".
    No ownership transfer!
*/</span>
<span class="k">virtual</span> <span class="k">const</span> <span class="n">QPixmap</span> <span class="o">*</span> <span class="n">icon</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

<span class="cm">/*! Optionally return a list of pixmaps to show in the plugin manager.
    nullptr means "no screenshots".
    No ownership transfer!
*/</span>
<span class="k">virtual</span> <span class="k">const</span> <span class="n">QList</span><span class="o">&lt;</span><span class="n">QPixmap</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">screenShots</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

<span class="cm">/*! If this function returns true, the plugin provides a
    settings/configuration page.
*/</span>
<span class="k">virtual</span> <span class="kt">bool</span> <span class="n">hasSettingsDialog</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

<span class="cm">/*! If a settings dialog page is provided, this function is called when
    the user clicks on the respective settings dialog menu entry.
    \param parent Parent class pointer, to be used as parent for modal dialogs.
    \return Returns a bitmask that signals what kind of update is needed
        in the user-interface as consequence of the settings dialogs
        changes (see SettingsDialogUpdateNeeds).
*/</span>
<span class="k">virtual</span> <span class="kt">int</span> <span class="nf">showSettingsDialog</span><span class="p">(</span><span class="n">QWidget</span> <span class="o">*</span> <span class="n">parent</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title()</code> - liefert einen kurzen Titel des Plugins, beispielsweise <code>IFC Import-Plugin</code>. Der Text kann internationalisiert werden, im Format <code>en:PV-Panel designer and optimizer|de:PV-Panel-Entwurfs- und Optimierung</code>.</p>
</li>
<li>
<p><code>icon()</code> - liefert optional ein Icon (min. 64x64 Pixel) zur Anzeige im Pluginmanager aus</p>
</li>
<li>
<p><code>screenShots()</code> - liefert optional eine Liste von Screenshots zur Anzeige im Pluginmanager aus</p>
</li>
<li>
<p><code>hasSettingsDialog()</code> - liefert optional true, falls das Plugin einen Einstellungsdialog hat, der ins <em>Plugins</em>-Hauptmenü eingegliedert werden soll</p>
</li>
<li>
<p><code>showSettingsDialog()</code> - implementiert die Anzeige des Plugin-spezifischen Einstellungsdialogs. Rückgabewert signalisiert, ob und inwieweit die Programmoberfläche aktualisiert werden soll</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Die anderen Schnittstellenfunktionen sind in den jeweils abgeleiteten Klassen deklariert.</p>
</div>
</div>
<div class="sect2">
<h3 id="_plugin_meta_daten">2.2. Plugin-Meta-Daten</h3>
<div class="paragraph">
<p>Die Metadaten des Plugins werden in einer JSON-Datei abgelegt, welche vom Resource-Compiler in das Plugin kompiliert wird und durch den PluginLoader ausgelesen wird. Damit muss die JSON-Datei nicht zusätzlich zum Plugin installiert werden.</p>
</div>
<div id="ex_JSON" class="exampleblock">
<div class="title">Beispiel 4. JSON-Plugin-Metadaten-Datei</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"short-description"</span><span class="p">:</span><span class="s2">"en:This is a dummy database plugin.|de:Dies ist ein Beispiel für ein Datenbank-Plugin."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"long-description"</span><span class="p">:</span><span class="s2">"en:This is a dummy database plugin that privides lots of data, but only as an example.|de:Dies ist ein Datenbank-Plugin dass unglaublich viele Daten liefert, aber eben nur als Beispiel."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"vicus-version"</span><span class="p">:</span><span class="s2">"0.9"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"webpage"</span><span class="p">:</span><span class="s2">"https://sim-vicus.de"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"author"</span><span class="p">:</span><span class="s2">"Andreas Nicolai"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"license"</span><span class="p">:</span><span class="s2">"LGPL 2 or newer"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title</code>: Titel des Plugins (wie zurückgeliefert von <code>title()</code>)</p>
</li>
<li>
<p><code>short-description</code>: Kurzbeschreibung des Plugins zur Anzeige im Pluginmanager, kann mehrzeilig sein.</p>
</li>
<li>
<p><code>long-description</code>: (optional) Langbeschreibung des Plugins, mit Detailinformationen und ggfs. Versions-/Updateinformation</p>
</li>
<li>
<p><code>version</code>: Version des <em>Plugins</em></p>
</li>
<li>
<p><code>vicus-version</code>: Kompatible SIM-VICUS-Versionen (Datenstrukturversionen)</p>
</li>
<li>
<p><code>webpage</code> : (optional) Webseite des Plugin-Entwicklers</p>
</li>
<li>
<p><code>author</code>: (optional) Authoren und Copyright-Info</p>
</li>
<li>
<p><code>license</code>: Lizenzinformation; bei <em>commercial</em>  sollte das Plugin eine Aktivierung/Lizensierung beinhalten</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Eigentlich wäre es ausreichend, den Titel/Namen des Plugins über die JSON-Metadaten zu übermitteln. Da der Pluginmanager aber bei fehlenden Metadaten dennoch in der Lage sein muss, das Plugin zu benennen, ist die zwingend zu implementierende pur virtuelle Memberfunktion <code>title()</code> der sicherste Weg, an einen Anzeigenamen zu kommen.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Die JSON-Datei wird beim Kompilieren angegeben, wie im <a href="#ex_PluginExample">Beispiel 5</a> gezeigt.</p>
</div>
<div id="ex_PluginExample" class="exampleblock">
<div class="title">Beispiel 5. Headerdatei eines minimalistischen Plugins</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cp">#ifndef DummyDatabasePluginH
#define DummyDatabasePluginH
</span>
<span class="cp">#include</span> <span class="cpf">&lt;QObject&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;QtPlugin&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;SVDatabasePluginInterface.h&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">DummyDatabasePlugin</span> <span class="o">:</span> <span class="k">public</span> <span class="n">QObject</span><span class="p">,</span> <span class="k">public</span> <span class="n">SVDatabasePluginInterface</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Q_OBJECT</span>
    <span class="n">Q_PLUGIN_METADATA</span><span class="p">(</span><span class="n">IID</span> <span class="s">"ibk.sim-vicus.Plugin.DatabaseInterface"</span>  <span class="kt">FILE</span> <span class="s">"../data/metadata.json"</span><span class="p">)</span>
    <span class="n">Q_INTERFACES</span><span class="p">(</span><span class="n">SVDatabasePluginInterface</span><span class="p">)</span>
<span class="nl">public:</span>

    <span class="c1">// SVCommonPluginInterface interface</span>
    <span class="n">QString</span> <span class="n">title</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s">"Database-Plugin-Dummy"</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">hasSettingsDialog</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;}</span>
    <span class="kt">int</span> <span class="n">showSettingsDialog</span><span class="p">(</span><span class="n">QWidget</span> <span class="o">*</span> <span class="n">parent</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="c1">// SVDatabasePluginInterface interface</span>
    <span class="kt">bool</span> <span class="n">retrieve</span><span class="p">(</span><span class="k">const</span> <span class="n">SVDatabase</span> <span class="o">&amp;</span> <span class="n">currentDB</span><span class="p">,</span> <span class="n">SVDatabase</span> <span class="o">&amp;</span> <span class="n">additionalDBElemnts</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif // DummyDatabasePluginH</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wichtig ist die Zeile mit <code>Q_PLUGIN_METADATA()</code>, in der sowohl die implementierte Schnittstelle also auch die Metadaten deklariert werden. Mit <code>Q_INTERFACES(SVDatabasePluginInterface)</code> werden die implementierten Schnittstellen angegeben, also letztlich die Klassen, welche vererbt und implementiert werden. Bei SIM-VICUS Plugins sollte dies immer nur eine Schnittstelle sein (auch wenn man sicherlich Import- und Databank-Plugin-Schnittstellen in einem Plugin kombinieren könnte).</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_plugin_erstellung">2.3. Plugin-Erstellung</h3>
<div class="paragraph">
<p>Das Plugin wird mit CMake oder qmake im Release-Modus übersetzt und es entsteht eine <code>dll</code> unter Windows oder <code>so</code>, bzw. <code>dylib</code> unter Linux bzw. Mac. Diese ist durch die eingebettete JSON-Datei bereits komplett fertig für die Auslieferung.</p>
</div>
</div>
<div class="sect2">
<h3 id="_plugin_veröffentlichung">2.4. Plugin-Veröffentlichung</h3>
<div class="paragraph">
<p>Plugins werden auf der SIM-VICUS-Webseite veröffentlicht. Das passiert entweder manuell durch den Admin oder durch das Plugin-Upload-Tool. Auf dem Server befindet sich eine Plugin-Listen-Datei im JSON-Format, welche eine Übersicht über alle verfügbaren Plugins und deren Versionsnummern enthält.</p>
</div>
<div class="paragraph">
<p>Die Plugins selbst werden in einer Verzeichnisstruktur auf dem Server gehostet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>plugins.json
plugins/
  1/
    screenshots/
      image1.png
      image2.png
      ...
      imageN.png
    1.0/
      BrickMaterialDBPlugin.zip
      BrickMaterialDBPlugin.json
    1.1/
      BrickMaterialDBPlugin.zip
      BrickMaterialDBPlugin.json
  2/
    2.5.2/
      PVDesignPlugin.zip
      PVDesignPlugin.json
      ...
  3/
    ...</pre>
</div>
</div>
<div class="paragraph">
<p>Top-Level liegt die Plugin-Listen-Datei <code>plugins.json</code>. In dieser werden Plugins, deren Versionen und deren VICUS-Kompatibilitäts-Versionen mit dem jeweiligen Pfad referenziert, also beispielsweise:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
   </span><span class="nl">"plugins"</span><span class="p">:[</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"Brick Material DB Plugin"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"short-description"</span><span class="p">:</span><span class="s2">"xxx"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"long-description"</span><span class="p">:</span><span class="s2">"xxx"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"vicus-version"</span><span class="p">:</span><span class="s2">"0.9"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"webpage"</span><span class="p">:</span><span class="s2">"https://sim-vicus.de"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"author"</span><span class="p">:</span><span class="s2">"Andreas Nicolai"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"license"</span><span class="p">:</span><span class="s2">"LGPL 2 or newer"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"screenshots"</span><span class="p">:[</span><span class="w">
            </span><span class="s2">"image1.png"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"image2.png"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"image3.png"</span><span class="w">
         </span><span class="p">],</span><span class="w">
         </span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"1/1.0/BrickMaterialDBPlugin"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"Brick Material DB Plugin"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"short-description"</span><span class="p">:</span><span class="s2">"xxx"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"long-description"</span><span class="p">:</span><span class="s2">"xxx"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"1.1"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"vicus-version"</span><span class="p">:</span><span class="s2">"0.9"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"webpage"</span><span class="p">:</span><span class="s2">"https://sim-vicus.de"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"author"</span><span class="p">:</span><span class="s2">"Andreas Nicolai"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"license"</span><span class="p">:</span><span class="s2">"LGPL 2 or newer"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"screenshots"</span><span class="p">:[</span><span class="w">
            </span><span class="s2">"image1.png"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"image2.png"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"image5-newVersion.png"</span><span class="w">
         </span><span class="p">],</span><span class="w">
         </span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"1/1.1/BrickMaterialDBPlugin"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"PV Panel Designer"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"short-description"</span><span class="p">:</span><span class="s2">"xxx"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"long-description"</span><span class="p">:</span><span class="s2">"xxx"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"2.5.2"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"vicus-version"</span><span class="p">:</span><span class="s2">"0.9"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"webpage"</span><span class="p">:</span><span class="s2">"https://sim-vicus.de"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"author"</span><span class="p">:</span><span class="s2">"Andreas Nicolai"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"license"</span><span class="p">:</span><span class="s2">"LGPL 2 or newer"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"2/2.5.2/PVDesignPlugin"</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die JSON-Datei enthält effektiv die Metadaten der einzelnen Plugins und zusätzlich das Element <code>path</code>.</p>
</div>
<div class="paragraph">
<p>Durch Anhängen von <code>*.zip</code> bzw. <code>*.json</code> an den <code>path</code> erhält man die jeweiligen Dateien zum Download.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Die Ablage der Plugin-JSON-Dateien ist notwendig, sodass bei Dateioperationen z.B. Kopieren eines Plugin-Verzeichnisses in die Verzeichnisstruktur, ein Skript automatisiert eine aktualisierte <code>plugins.json</code> generieren kann, die dann immer synchron mit der Verzeichnisliste ist und somit keine 404-Fehler beim Download liefert.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Die Angabe von <em>screenshots</em> ist optional. Screenshots werden im Plugin-Top-Level-Verzeichnis, also bspw. <code>1/screenshots</code> oder <code>2/screenshots</code> abgelegt, sodass die gleichen Screenshots von mehrere Plugin-Versionen referenziert werden können (Screenshots ändern sich ja kaum). Referenziert werden diese dann <em>ohne</em> Pfadangabe, also nur via <code>image1.png</code>. Falls bei einer neuen Pluginversion neue/aktualisierte Screenshotversionen hinzukommen, so gibt man in der <code>screenshots</code>-Zeile für dieses Plugin einfach die neuen Dateinamen für die Screenshots an.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Der Titel eines Plugins sollte sich eigentlich nicht ändern. Aber es wäre möglich, dass bei einem Update bspw. Tippfehler oder Übersetzungsfehler behoben werden, wodurch das Plugin eben einen anderen Titel erhalten könnte.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Plugins mit gleichem obersten Pfad (durchnummeriert, 1, 2, etc.) sind unterschiedliche Versionen des gleichen Plugins und werden vom Plugin-Manager entsprechend nur einmal in der Liste dargestellt. Aus Sicht des Website-Hostings sollte der Workflow beim Plugin-Download immer so aussehen:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download der Datei <a href="https://sim-vicus.de/plugins/plugins.json" class="bare">https://sim-vicus.de/plugins/plugins.json</a></p>
</li>
<li>
<p>Generieren der Plugin-Liste</p>
</li>
<li>
<p>Für jedes angezeigte Plugin generieren der Screenshot-Pfade und Download/Cache der Screenshot-Bilder.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nun kann eine vollständige Liste/Übersicht aller verfügbaren Plugins angezeigt werden.</p>
</div>
<div class="paragraph">
<p>Bei der Installation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Nutzer-Auswahl eines Plugins und Version, woraus sich der Pfad ergib, z.B. <code>1/1.0/BrickMaterialDBPlugin</code></p>
</li>
<li>
<p>Download des Plugins <code>1/1.0/BrickMaterialDBPlugin.zip</code> und entpacken im nutzerspezifischen Pluginsverzeichnis: <code>%APPDATA%/SIM-VICUS/plugins/</code> bzw. <code>~/.local/share/SIM-VICUS/plugins</code>. Dabei wird die Verzeichnisstruktur auf dem Server gespiegelt.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Man könnte einfach die gesamte Verzeichnisstruktur im <code>plugins</code>-Verzeichnis lokal in des nutzerspezifische Pluginsverzeichnis kopieren und SIM-VICUS würde dann beim Start alle kompatiblen Plugins laden. Das erleichtert Tests und Entwicklung, da man nur eine Verzeichnisstruktur unterstützen und parsen muss.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0 (01.01.2023)<br>
Last updated 2023-01-01 13:06:45 +0100
</div>
</div>
</body>
</html>